#!/usr/bin/env bash
# carbon-ok-enhanced: Enhanced version with confidence and period awareness
# Exit 0 if conditions are favorable for running

INTENSITY_FILE="/run/carbon/intensity"
PERIOD_FILE="/run/carbon/period"
CONFIDENCE_FILE="/run/carbon/confidence"
UPDATED_FILE="/run/carbon/updated_at"
TTL_FILE="/run/carbon/ttl"

# Defaults (configurable via environment)
CARBON_THRESHOLD=${CARBON_THRESHOLD:-300}
ALLOW_PEAK=${ALLOW_PEAK:-false}
REQUIRE_HIGH_CONFIDENCE=${REQUIRE_HIGH_CONFIDENCE:-false}

# Helper: read file with fallback
read_with_fallback() {
    local file="$1"
    local fallback="$2"
    if [ -f "$file" ]; then
        cat "$file" 2>/dev/null || echo "$fallback"
    else
        echo "$fallback"
    fi
}

# Read values
intensity=$(read_with_fallback "$INTENSITY_FILE" "-1")
period=$(read_with_fallback "$PERIOD_FILE" "unknown")
confidence=$(read_with_fallback "$CONFIDENCE_FILE" "medium")
updated_at=$(read_with_fallback "$UPDATED_FILE" "0")
ttl=$(read_with_fallback "$TTL_FILE" "1800")

# Check if data is stale
now=$(date +%s)
if [ $((now - updated_at)) -gt "$ttl" ] && [ "$ttl" -ne 0 ]; then
    echo "[INFO] Carbon data is stale (updated: $updated_at, ttl: $ttl)" >&2
    # Continue anyway - stale is better than nothing
fi

# Validate intensity range
if [ "$intensity" -ne -1 ]; then
    if [ "$intensity" -lt 0 ] || [ "$intensity" -gt 2000 ]; then
        echo "[WARN] Invalid intensity value: $intensity" >&2
        intensity="-1"  # Treat as unknown
    fi
fi

# Check carbon intensity
if [ "$intensity" -ne -1 ] && [ "$intensity" -gt "$CARBON_THRESHOLD" ]; then
    echo "[INFO] High carbon intensity ($intensity > $CARBON_THRESHOLD)" >&2
    # Continue checking - intensity alone doesn't block
fi

# Check period (if we care about peaks)
if [ "$ALLOW_PEAK" = "false" ] && [ "$period" = "peak" ]; then
    echo "[INFO] Peak period detected" >&2
    exit 1
fi

# Check confidence (if we require high confidence)
if [ "$REQUIRE_HIGH_CONFIDENCE" = "true" ] && [ "$confidence" != "high" ]; then
    echo "[INFO] Low confidence data ($confidence)" >&2
    exit 1
fi

# If we get here, it's OK to run
exit 0
